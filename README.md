# datastore-support repo overview

The datastore-support repo contains tools and utilities for managing the ecosystem of services comprising a deployment of the MPEX datastore Java server applications.  These applications offer APIs for storing and retrieving data captured from a running particle accelerator (or other large experimental facility), providing a platform for building machine learning and other analytics tools for use within control systems.  The [datastore](https://github.com/osprey-dcs/datastore) application provides an ingestion service for capturing incoming data, and the [datastore-service](https://github.com/osprey-dcs/datastore-service) application offers a query service.

The API provided by these servers is implemented using the [gRPC](https://grpc.io/) high performance remote procedure call (RPC) framework.  The server applications utilize both [InfluxDB](https://www.influxdata.com/) time series database platform and [MongoDB](https://www.mongodb.com/) document-oriented/NoSQL database platform.

The datastore-support repo provides tools for managing the supporting services required to run the Java server applications.  It can be used for production/demo/test deployments of the applications as well as development environments supporting Java development work on the server applications as well as JavaScript development efforts to create a [React](https://reactjs.org/) based [web application](https://github.com/craigmcchesney/datastore-web-app) for navigating the datastore and a [Node.js](https://nodejs.org/en/) based [server](https://github.com/craigmcchesney/datastore-server-app) for deploying the web app and augmenting the datastore server APIs.

Deployments of the datastore-support ecosystem utilize the [datastore-deployment](https://github.com/craigmcchesney/datastore-deployment) github repo for managing deployment-specific artifacts like config files and crontabs.  A new branch should be created in that repo for each deployment, starting from a branch used for a similar deployment configuration.

## ecosystem support services

I decided to utilize docker-based containers for the support services that are required by the Java server applications to simplify deploying new systems.  This is great for development, testing, and demo environments.  It may be desirable to use the full installation of the database packages on a real production deployment for performance and administrative reasons.  A lot of the datastore-support repo tools would be useful for either type of deployment (with a little bit of work).

The datastore-support environment utilizes docker containers for deploying the following services:

* InfuxDB - time series database platform
* MongoDB - document-oriented / NoSQL database platform
* envoy - proxy engine for converting web application traffic generated by web browsers using HTTP to HTTP/2 for compatibility with gRPC Java server

## datastore-support repo directory details

### bin

The bin directory includes shell scripts for managing individual services, starting and stopping the entire service ecosystem, creating/removing/starting/stopping docker containers, running the gRPC protoc compiler (for generating JavaScript stubs from the Java server application gRPC API protobuf files), and starting the eclipse (Java) and webstorm (JavaSecript) development environments.

### docker

The docker directory includes configuration files for creating docker containers for the support services.  A docker-compose configuration (docker-compose.yml) is provided for running influxdb, mongodb, and mongo express (web portal for MongoDB).  A separate docker configuration (envoy.yaml)  is included for creating a container running the envoy proxy.

### env

The env directory includes scripts for setting up the Linux environment for the user running the ecosystem.  The "datastore-env" script should be called by the Linux user's .bashrc script, and adds environment variables for use by the datastore-support repo's scripts (in bin directory).  It also includes template crontab files for different kinds of deployments.  The crontab.datastore-support template starts the full ecosystem including support services, Java server applications, and Javascript server/web applications.  There are also crontab templates for development VMs to be used for either Java or JavaScript development that only start the support services and whatever other parts of the ecosystem are needed for development.

## using the datastore-support repo tools

### create branch of datastore-deployment repo and clone to home directory

This repo is intended to be used with the datastore-deployment repo.  A new branch of that repo should be created for the new deployment and cloned to ~/datastore-deployment in the home directory of the Linux user that will run the service ecosystem.  The config and crontab files should be tailored as appropriate for the deployment including influxdb/mongodb authentication details, which services to start (e.g., production vs. development), etc.

### clone datastore-support repo to home directory

The datastore-support repo should be cloned to ~/datastore-support.

### create docker containers for support services

The ~/datastore-support/bin/support-services-create script is used to create docker containers for influxdb, mongodb, and envoy proxy.

### use influxdb portal to create "bucket"

After creating docker containers for the support services, the InfluxDB [web portal running in the docker container](http://localhost:8086/) is used to initialize the "bucket" for the datastore applications (user/bucket name "datastore", organization "ospreydcs").

NOTE: it is on the todo list to create the docker container for InfluxDB using config file values for user, bucket, and organization name etc but for now it works the other way around.

### check mongodb installation using mongoexpress

The [mongo express web portal](http://localhost:8081/) can be used to navigate the MongoDB running in the docker container.  The initial database contains no schema as you'd expect to see in a relational database platform.  The ingestion services initializes the database structure and builds on it as data are added.

### use appropriate ecosystem-start variant to bring up the system

The ~/datastore-support/bin/ecosystem-start script is used to bring up a full ecosystem with support services, Java servers, and JavaScript server/web applications.  The ecosystem-start-dev-java and ecosystem-start-dev-web-app scripts can be used to bring up services for a development system.

### add the ecosystem-start script invocation to crontab

The crontab templates in ~/datastore-support/env can be used to create a crontab for the user that runs the ecosystem.  Choose the template for the appropriate ecosystem-start script variant from above.  The crontab includes a "reboot" entry that will start the ecosystem when the system/VM is booted.

### java development

For Java development, use the ~/datastore-support/bin/eclipse script to run eclipse.  The datastore repos are meant to be installed to and loaded from ~/datastore-support/repos.

### javascript development

For Javascript development, use the ~/datastore-support/bin/webstorm script to run webstorm.  The React web application repo is cloned to ~/datastore-web-app.  The Node.js server is cloned to ~/datastore-server-app, and includes a symbolic link called "client" which points to the datastore-web-app directory.  For now there are 2 independent repos, one for the client and one for the server.  At some point, I might merge this to use a single repo for both, or to use a git submodule for the client within the server directory.

### web application

If the Node.js server for the web application is running, it can be accessed at http://localhost:9000 .  If the web application is started in the webpack development server, it will be found at http://localhost:3000 .
